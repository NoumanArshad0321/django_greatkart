{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* Custom Styles for Product Detail Page */
body {
    overflow-x: hidden;
}
.color-circle {
    display: inline-block;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #ccc;
    transition: transform 0.2s ease, border-color 0.2s ease;
}
.color-circle:hover {
    transform: scale(1.15);
    border-color: #000;
}
.color-circle.selected {
    border: 3px solid var(--primary-color, #007bff); /* Use a default color if not set */
    transform: scale(1.15);
}
.gallery-thumbs img {
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s ease;
}
.gallery-thumbs img:hover,
.gallery-thumbs img.selected {
    border-color: var(--primary-color, #007bff);
}
.img-big-wrap {
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.img-big-wrap img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* Star Rating CSS */
.rate {
    display: inline-block;
    border: 0;
    float: left; /* Keep this to align with the text */
}
.rate > input {
    display: none;
}
.rate > label {
    float: right;
    width: 1.1em;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
    font-size: 1.5rem;
    color: #ccc;
    position: relative;
}
.rate > label:before {
    content: 'â˜…';
    font-family: 'FontAwesome'; /* Make sure FontAwesome is linked in your base.html */
    margin: 0;
    padding: 0.3rem .2rem;
}
.rate > input:checked ~ label {
    color: #ffb503;
}
.rate > label:hover,
.rate > label:hover ~ label {
    color: #deb217;
}
.rate > input:checked + label:hover, 
.rate > input:checked ~ label:hover,
.rate > input:checked ~ label:hover ~ label,
.rate > label:hover ~ input:checked ~ label {
    color: #c59b08;
}
.validation-message {
    color: red;
    font-size: 0.9em;
    margin-top: 5px;
    display: none; /* Initially hidden */
}
</style>

<section class="section-content padding-y bg">
    <div class="container">
        <div class="row gx-4">
            <aside class="col-md-6">
                <div class="card">
                    <article class="gallery-wrap">
                        <div class="img-big-wrap">
                            <img class="main-product-image" src="{{ single_product.image.url }}" alt="{{ single_product.product_name }}">
                        </div>
                        <div class="thumbs-wrap gallery-thumbs d-flex gap-2 mt-2">
                            {% for variation in single_product.variation_set.all %}
                                {% if variation.image %}
                                <img src="{{ variation.image.url }}" width="60" height="60" alt="{{ variation.variation_value }}">
                                {% endif %}
                            {% endfor %}
                        </div>
                    </article>
                </div>
            </aside>

            <main class="col-md-6">
                <form id="add-to-cart-form" action="{% url 'add_cart' single_product.id %}" method="POST">
                    {% csrf_token %}
                    <article class="product-info-aside">
                        <h2 class="title mt-3">{{ single_product.product_name }}</h2>
                         <div class="rating-star">
                            <span>
                                <i class="{% if single_product.averageReview >= 0.5 %}{% if single_product.averageReview < 1 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 1.5 %}{% if single_product.averageReview < 2 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 2.5 %}{% if single_product.averageReview < 3 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 3.5 %}{% if single_product.averageReview < 4 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 4.5 %}{% if single_product.averageReview < 5 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                            </span>
                <span class="review-count"> {{ single_product.countReview }} reviews</span>
                        </div>
                        

                        <div class="mb-3">
                            <var class="price h4">${{ single_product.price }}</var>
                        </div>
                        <p>{{ single_product.description }}</p>

                        <div class="row mb-3">
                            <div class="item-option-select">
                                <h6>Choose Color</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    {% for i in single_product.variation_set.colors %}
                                    <span class="color-circle" 
                                          style="background-color: {{ i.variation_value|lower }};" 
                                          data-color="{{ i.variation_value|lower }}" 
                                          data-image="{{ i.image.url }}"
                                          title="{{ i.variation_value }}">
                                    </span>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="color" id="selectedColor">
                                <span id="color-validation-message" class="validation-message">Please select a color.</span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="item-option-select">
                                <h6>Select Size</h6>
                                <div class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons">
                                    {% for i in single_product.variation_set.sizes %}
                                    <label class="btn btn-light">
                                        <input type="radio" name="size" value="{{ i.variation_value|lower }}" required> 
                                        {{ i.variation_value }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <span class="text">Add to cart</span> <i class="fas fa-shopping-cart"></i>
                        </button>
                    </article>
                </form>
            </main>
        </div>

        <div class="row mt-5">
            <div class="col-md-9">
                <header class="section-heading mb-4">
                    <h3>Customer Reviews </h3>
                    
                     <div class="rating-star">
                            <span>
                                <i class="{% if single_product.averageReview >= 0.5 %}{% if single_product.averageReview < 1 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 1.5 %}{% if single_product.averageReview < 2 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 2.5 %}{% if single_product.averageReview < 3 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 3.5 %}{% if single_product.averageReview < 4 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                                <i class="{% if single_product.averageReview >= 4.5 %}{% if single_product.averageReview < 5 %}fas fa-star-half-alt{% else %}fas fa-star{% endif %}{% else %}far fa-star{% endif %}"></i>
                            </span>
                <span class="review-count"> {{ single_product.countReview }} reviews</span>
                        </div>
                    

                      
                    <hr>
                </header>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Write Your Review</h5>
                        <form action="{% url 'submit_review' single_product.id %}" method="POST">
                            {% csrf_token %}
                            <div class="mb-3 d-flex align-items-center">
                                <label class="form-label me-3 mb-0">How do you rate this product?</label>
                                <div class="rate">
                                    <input type="radio" name="rating" id="rating5" value="5" required><label for="rating5" title="5"></label>
                                    <input type="radio" name="rating" id="rating4" value="4"><label for="rating4" title="4"></label>
                                    <input type="radio" name="rating" id="rating3" value="3"><label for="rating3" title="3"></label>
                                    <input type="radio" name="rating" id="rating2" value="2"><label for="rating2" title="2"></label>
                                    <input type="radio" name="rating" id="rating1" value="1"><label for="rating1" title="1"></label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="review-title" class="form-label">Review Title:</label>
                                <input type="text" name="subject" id="review-title" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="your-review" class="form-label">Your Review:</label>
                                <textarea name="review" id="your-review" class="form-control" rows="5"></textarea>
                            </div>

                            {% if user.is_authenticated %}
                                {% if orderproduct %}
                                <input type="submit" value="Submit Review" class="btn btn-primary">
                                {% else %}
                                <p class="text-muted">You must purchase this product before you can review it.</p>
                                {% endif %}
                            {% else %}
                            <p class="text-muted">Please <a href="{% url 'login' %}">login</a> to submit your review.</p>
                            {% endif %}
                        </form>
                    </div>
                </div>
                {% for review in reviews %}
                <article class="box mb-3">
                    <div class="icontext w-100">
                        <img src="{% static 'images/avatars/avatar1.jpg' %}" class="img-xs icon rounded-circle me-3" alt="User Avatar">
                        <div class="text">
                            <span class="date text-muted float-md-right">{{ review.updated_at }} </span> 
                            <h7 class="mb-1">{{ review.user.full_name }}</h7>
                            <div class='rating-star'>
                                <span >
                                    <i class="fa fa-star{% if review.rating == 0.5 %}-half-o{% elif review.rating < 1 %}-o{% endif %}" aria-hidden="true"></i>
                                    <i class="fa fa-star{% if review.rating == 1.5 %}-half-o{% elif review.rating < 2 %}-o{% endif %}" aria-hidden="true"></i>
                                    <i class="fa fa-star{% if review.rating == 2.5 %}-half-o{% elif review.rating < 3 %}-o{% endif %}" aria-hidden="true"></i>
                                    <i class="fa fa-star{% if review.rating == 3.5 %}-half-o{% elif review.rating < 4 %}-o{% endif %}" aria-hidden="true"></i>
                                    <i class="fa fa-star{% if review.rating == 4.5 %}-half-o{% elif review.rating < 5 %}-o{% endif %}" aria-hidden="true"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h8>{{ review.subject }}</h8>
                        <p>
                            {{ review.review }}
                        </p> 
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const colorCircles = document.querySelectorAll('.color-circle');
    const selectedColorInput = document.getElementById('selectedColor');
    const mainImage = document.querySelector('.main-product-image');
    const thumbs = document.querySelectorAll('.gallery-thumbs img');
    const addToCartForm = document.getElementById('add-to-cart-form');
    const colorValidationMessage = document.getElementById('color-validation-message');

    // Select color by clicking circle
    colorCircles.forEach(circle => {
        circle.addEventListener('click', function() {
            colorCircles.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedColorInput.value = this.getAttribute('data-color');
            const newImage = this.getAttribute('data-image');
            if (newImage) {
                mainImage.src = newImage;
            }
            colorValidationMessage.style.display = 'none'; // Hide error message on selection
        });
    });

    // Switch when thumbnail clicked
    thumbs.forEach(thumb => {
        thumb.addEventListener('click', function() {
            mainImage.src = this.src;
        });
    });

    // Form validation for color selection
    addToCartForm.addEventListener('submit', function(e) {
        if (!selectedColorInput.value) {
            e.preventDefault(); // Stop form submission
            colorValidationMessage.style.display = 'block'; // Show error message
        }
    });
});
</script>
{% endblock %}